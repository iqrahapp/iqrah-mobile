# Handover: Task 1.4 - Integer ID Refactoring (2)

**Prepared by:** Jules
**Date:** 2025-11-26

## 1. Objective

The primary goal is to complete **Task 1.4: Refactor SqliteContentRepository to use integer-based (`i64`) IDs** instead of `String` ukeys for all internal database operations and service logic. This aligns with the "Internal Ints, External Strings" architectural principle.

This task is a continuation of the work on branch `claude/revert-scheduler-candidates-011b51MVzfCZ3M6rGkZdK8yt`.

## 2. Summary of Work and Current State

I have made significant progress on the refactoring, but have been unable to fully resolve the resulting compilation errors. The current state is that the `domain/models.rs` and the `exercises` module have been partially updated, but the test files are still failing to compile.

### Actions Taken:

1.  **Core Data Model Refactoring:** I updated the `Exercise` enum and `EchoRecallWord` struct in `domain/models.rs` to use `i64` for their ID fields. I also updated the `PropagationEvent` and `PropagationDetail` structs to use `i64` for their node ID fields.
2.  **Exercise Signature Refactoring:** I updated the function signatures for the main exercise types (`Memorization`, `MCQ`, `Translation`) and their corresponding generator functions in `generators.rs` to accept `i64` IDs and `&str` ukeys.
3.  **Trait Refactoring:** I updated the `Exercise` trait in `exercises/types.rs` to use `i64` for the `get_node_id` method.
4.  **Test File Refactoring:** I have attempted to fix the test files, but have been unsuccessful. The compiler errors persist, and I believe my context has grown too large to effectively debug the issue.

### Current Status: **Blocked by Compilation Errors**

The workspace is in a non-compilable state. Running `cd rust && cargo test --no-run` reveals over 200 compilation errors, all stemming from type mismatches in the test files, particularly `exercises/enum_tests.rs`.

## 3. Recommended Next Steps for the Next Agent

A systematic, bottom-up approach is required to resolve this. I recommend starting over with the test files.

1.  **Verify Current State:** Start by running `cd rust && cargo test --no-run` from the project root to see the full list of current errors.

2.  **Focus on `iqrah-core`:** This crate is the epicenter of the errors. Resolve all issues here before moving to other crates.

3.  **Fix Test Code (Bottom-Up Errors):**
    *   Go to each test file indicated by the compiler (e.g., `exercises/enum_tests.rs`).
    *   Update the test data and `::new()` calls to pass the correct arguments (e.g., `Exercise::new(111, "WORD_INSTANCE:1:1:1", &repo)` instead of just `Exercise::new("WORD_INSTANCE:1:1:1", &repo)`).
    *   Update all `assert_eq!` macros to compare `i64` values, not strings.

4.  **Iterate and Re-compile:** After fixing one file, run `cargo test --no-run` again. The number of errors should decrease significantly with each file fixed. Continue this process until `iqrah-core` compiles successfully.

5.  **Address Downstream Crates:** Once `iqrah-core` is clean, move to `iqrah-storage` and `iqrah-api` to fix any remaining compilation errors that result from the updated trait definitions.

The final goal is a fully compilable workspace where `cd rust && cargo test` runs and all tests pass. Good luck.