# Task 2.4: Add Cross-Axis Propagation Verification

## Metadata
- **Priority:** P0 (Core Feature Validation)
- **Estimated Effort:** 1 day
- **Dependencies:** Task 2.1 (Knowledge graph with cross-axis edges)
- **Agent Type:** Testing + Validation
- **Parallelizable:** Yes (with 2.2, 2.3 after 2.1 completes)

## Goal

Verify that energy propagation works correctly across knowledge axes (e.g., translation success helps memorization), validating the cross-learning synergy design.

## Context

**Knowledge Axis Cross-Synergy Design:**
The knowledge graph is designed with cross-axis edges to model how different types of learning reinforce each other:

- **Translation → Memorization:** Understanding meaning helps recall
- **Tafsir → Translation:** Context aids understanding
- **Contextual Memorization → Memorization:** Word-level recall helps verse recall
- **Memorization → Translation:** Recitation familiarity aids meaning recognition

**Current State:**
- ✅ Rust code handles energy propagation (from MVP/scheduler v2)
- ✅ Knowledge graph should have cross-axis edges (from Task 2.1)
- ❓ Unknown: Do cross-axis edges actually exist in the data?
- ❓ Unknown: Does propagation work as designed?

**This Task:**
- Verify cross-axis edges exist in database
- Test energy propagation across axes
- Measure synergy effects
- Document actual propagation behavior

## Current State

**Energy Propagation Implementation:**
- **File:** `rust/crates/iqrah-core/src/services/learning_service.rs`
- **Logic:** Already implemented (from scheduler v2)
  1. User reviews node
  2. Update FSRS state
  3. Get outgoing edges
  4. Sample distribution
  5. Add energy to target nodes

**Cross-Axis Edges (Should Exist):**
- **Generated by:** `research_and_dev/iqrah-knowledge-graph2/src/iqrah/graph/knowledge_builder.py`
- **Edge type:** `EdgeType::Knowledge` (type 1)
- **Example:** `1:1:translation` → `1:1:memorization` with weight 0.3

**Unknown:**
- Are cross-axis edges in the migration file?
- What are the actual edge weights?
- Does propagation work in practice?

## Target State

### Cross-Axis Edge Verification

**Database queries to verify edges exist:**
```sql
-- Check for cross-axis edges
SELECT
    source_id,
    target_id,
    distribution_param1
FROM edges
WHERE edge_type = 1
    AND source_id LIKE '%:translation'
    AND target_id LIKE '%:memorization'
LIMIT 10;

-- Expected: 10+ edges with source ending in :translation and target in :memorization
```

### Propagation Tests

**Test Cases:**
1. Review translation node → Memorization node gains energy
2. Review tafsir node → Translation node gains energy
3. Review memorization node → Translation node gains energy (if designed)
4. Verify edge weights are reasonable (0.1 - 0.5 range)

### Documentation

**File:** `docs/testing/cross-axis-propagation-analysis.md`

Contains:
- Graph structure analysis (which axes connect to which)
- Edge weight distribution
- Propagation test results
- Synergy effect measurements

## Implementation Steps

### Step 1: Verify Cross-Axis Edges in Database (30 min)

**Commands:**
```bash
cd rust

# Initialize database with Task 2.1 migration
cargo run --bin iqrah-cli -- init

# Query cross-axis edges
sqlite3 ~/.local/share/iqrah/content.db <<EOF
-- Count knowledge edges by source/target axis
SELECT
    SUBSTR(source_id, INSTR(source_id, ':') + 1) as source_axis,
    SUBSTR(target_id, INSTR(target_id, ':') + 1) as target_axis,
    COUNT(*) as edge_count,
    AVG(distribution_param1) as avg_weight
FROM edges
WHERE edge_type = 1
    AND source_id LIKE '%:%'
    AND target_id LIKE '%:%'
GROUP BY source_axis, target_axis
ORDER BY edge_count DESC;
EOF
```

**Expected output:**
```
source_axis         | target_axis         | edge_count | avg_weight
--------------------+--------------------+------------+-----------
translation         | memorization        | 493        | 0.30
tafsir              | translation         | 493        | 0.25
memorization        | memorization        | 492        | 0.80  (sequential)
contextual_memorization | memorization   | 100        | 0.40
```

**Verify:**
- [ ] Cross-axis edges exist
- [ ] Multiple axis pairs connected
- [ ] Edge weights in reasonable range (0.1 - 0.8)

### Step 2: Create Propagation Test Suite (2-3 hours)

**File:** `rust/tests/cross_axis_propagation_test.rs` (NEW)

```rust
use iqrah_core::services::learning_service::LearningService;
use iqrah_core::domain::models::Rating;
use iqrah_storage::{init_content_db, init_user_db};
use tempfile::TempDir;

#[tokio::test]
async fn test_translation_helps_memorization() {
    let (content_repo, user_repo) = setup_test_repos().await;
    let learning_service = LearningService::new(content_repo.clone(), user_repo.clone());

    // Initial state: Memorization node has no energy
    let initial_state = user_repo
        .get_memory_state("default", "1:1:memorization")
        .await
        .unwrap();

    let initial_energy = initial_state
        .map(|s| s.energy)
        .unwrap_or(0.0);

    // Review translation node
    learning_service
        .record_review("default", "1:1:translation", Rating::Good)
        .await
        .unwrap();

    // Check memorization node energy increased
    let after_state = user_repo
        .get_memory_state("default", "1:1:memorization")
        .await
        .unwrap()
        .expect("Memorization node should have state after propagation");

    assert!(
        after_state.energy > initial_energy,
        "Memorization energy should increase after translation review. Before: {}, After: {}",
        initial_energy,
        after_state.energy
    );

    // Energy increase should be moderate (0.1 - 0.5 range for cross-axis)
    let energy_gain = after_state.energy - initial_energy;
    assert!(
        energy_gain > 0.05 && energy_gain < 0.6,
        "Cross-axis energy gain should be 0.05-0.6. Actual: {}",
        energy_gain
    );
}

#[tokio::test]
async fn test_tafsir_helps_translation() {
    let (content_repo, user_repo) = setup_test_repos().await;
    let learning_service = LearningService::new(content_repo, user_repo.clone());

    let initial_energy = get_node_energy(&user_repo, "1:1:translation").await;

    // Review tafsir node
    learning_service
        .record_review("default", "1:1:tafsir", Rating::Good)
        .await
        .unwrap();

    let after_energy = get_node_energy(&user_repo, "1:1:translation").await;

    assert!(
        after_energy > initial_energy,
        "Translation energy should increase after tafsir review"
    );
}

#[tokio::test]
async fn test_propagation_event_recorded() {
    let (content_repo, user_repo) = setup_test_repos().await;
    let learning_service = LearningService::new(content_repo, user_repo.clone());

    // Review translation node
    learning_service
        .record_review("default", "1:1:translation", Rating::Good)
        .await
        .unwrap();

    // Check propagation events were recorded
    let events = user_repo
        .get_propagation_events("default", "1:1:translation", 10)
        .await
        .unwrap();

    assert!(!events.is_empty(), "Propagation events should be recorded");

    // Verify cross-axis propagation event exists
    let cross_axis_event = events.iter().find(|e| {
        e.target_node_id == "1:1:memorization"
    });

    assert!(
        cross_axis_event.is_some(),
        "Should find cross-axis propagation to memorization"
    );
}

#[tokio::test]
async fn test_multiple_axes_accumulate_energy() {
    let (content_repo, user_repo) = setup_test_repos().await;
    let learning_service = LearningService::new(content_repo, user_repo.clone());

    let initial_energy = get_node_energy(&user_repo, "1:1:memorization").await;

    // Review multiple axes that should help memorization
    learning_service
        .record_review("default", "1:1:translation", Rating::Good)
        .await
        .unwrap();

    learning_service
        .record_review("default", "1:1:tafsir", Rating::Good)
        .await
        .unwrap();

    let after_energy = get_node_energy(&user_repo, "1:1:memorization").await;

    // Memorization should have gained energy from both
    let total_gain = after_energy - initial_energy;

    assert!(
        total_gain > 0.1,
        "Memorization should accumulate energy from multiple axes. Gain: {}",
        total_gain
    );
}

async fn get_node_energy(user_repo: &Arc<dyn UserRepository>, node_id: &str) -> f64 {
    user_repo
        .get_memory_state("default", node_id)
        .await
        .unwrap()
        .map(|s| s.energy)
        .unwrap_or(0.0)
}

async fn setup_test_repos() -> (Arc<dyn ContentRepository>, Arc<dyn UserRepository>) {
    // Setup similar to other tests
    // ...
}
```

### Step 3: Measure Synergy Effects (1-2 hours)

**File:** `rust/scripts/measure_cross_axis_synergy.sh` (NEW)

```bash
#!/bin/bash
set -e

echo "=========================================="
echo "Cross-Axis Synergy Measurement"
echo "=========================================="

# Initialize fresh database
cargo run --bin iqrah-cli -- init --force

echo ""
echo "=== Baseline: Memorization without cross-axis help ==="
cargo run --bin iqrah-cli -- stats --node-id "1:10:memorization"

echo ""
echo "=== Scenario 1: Translation → Memorization ==="
cargo run --bin iqrah-cli -- review --node-id "1:10:translation" --rating good
cargo run --bin iqrah-cli -- stats --node-id "1:10:memorization"

echo ""
echo "=== Scenario 2: Tafsir → Translation → Memorization ==="
cargo run --bin iqrah-cli -- review --node-id "1:11:tafsir" --rating good
cargo run --bin iqrah-cli -- stats --node-id "1:11:translation"
cargo run --bin iqrah-cli -- stats --node-id "1:11:memorization"

echo ""
echo "=== Scenario 3: Direct Memorization ==="
cargo run --bin iqrah-cli -- review --node-id "1:12:memorization" --rating good
cargo run --bin iqrah-cli -- stats --node-id "1:13:memorization"

echo ""
echo "=========================================="
echo "Synergy measurement complete!"
echo "=========================================="
```

Run and document energy values.

### Step 4: Analyze Graph Structure (1 hour)

**File:** `rust/scripts/analyze_cross_axis_graph.sh` (NEW)

```bash
#!/bin/bash

echo "Cross-Axis Graph Structure Analysis"
echo "===================================="

DB="$HOME/.local/share/iqrah/content.db"

echo ""
echo "1. Edge Count by Type:"
sqlite3 "$DB" "
SELECT
    CASE edge_type
        WHEN 0 THEN 'Dependency'
        WHEN 1 THEN 'Knowledge'
        ELSE 'Unknown'
    END as type,
    COUNT(*) as count
FROM edges
GROUP BY edge_type;
"

echo ""
echo "2. Cross-Axis Edge Pairs:"
sqlite3 "$DB" "
WITH axis_edges AS (
    SELECT
        CASE
            WHEN source_id LIKE '%:memorization' THEN 'memorization'
            WHEN source_id LIKE '%:translation' THEN 'translation'
            WHEN source_id LIKE '%:tafsir' THEN 'tafsir'
            WHEN source_id LIKE '%:tajweed' THEN 'tajweed'
            ELSE 'other'
        END as source_axis,
        CASE
            WHEN target_id LIKE '%:memorization' THEN 'memorization'
            WHEN target_id LIKE '%:translation' THEN 'translation'
            WHEN target_id LIKE '%:tafsir' THEN 'tafsir'
            WHEN target_id LIKE '%:tajweed' THEN 'tajweed'
            ELSE 'other'
        END as target_axis,
        distribution_param1 as weight
    FROM edges
    WHERE edge_type = 1
        AND source_id LIKE '%:%'
        AND target_id LIKE '%:%'
        AND source_axis != target_axis
)
SELECT
    source_axis || ' → ' || target_axis as connection,
    COUNT(*) as edge_count,
    ROUND(AVG(weight), 3) as avg_weight,
    ROUND(MIN(weight), 3) as min_weight,
    ROUND(MAX(weight), 3) as max_weight
FROM axis_edges
WHERE source_axis != target_axis
GROUP BY source_axis, target_axis
ORDER BY edge_count DESC;
"

echo ""
echo "3. Sample Cross-Axis Edges:"
sqlite3 "$DB" "
SELECT source_id, target_id, distribution_param1 as weight
FROM edges
WHERE edge_type = 1
    AND source_id LIKE '%:translation'
    AND target_id LIKE '%:memorization'
LIMIT 5;
"
```

### Step 5: Document Findings (1-2 hours)

**File:** `docs/testing/cross-axis-propagation-analysis.md`

```markdown
# Cross-Axis Propagation Analysis

**Date:** 2024-11-24
**Task:** 2.4 - Cross-Axis Propagation Verification

## Executive Summary

[Summary of findings: Do cross-axis edges exist? Does propagation work?]

## Graph Structure

### Edge Statistics

| Edge Type | Count | Percentage |
|-----------|-------|------------|
| Dependency | XXX | YY% |
| Knowledge | XXX | YY% |
| **Total** | XXX | 100% |

### Cross-Axis Connections

| Connection | Edge Count | Avg Weight | Min | Max |
|------------|-----------|-----------|-----|-----|
| translation → memorization | XXX | 0.XX | 0.XX | 0.XX |
| tafsir → translation | XXX | 0.XX | 0.XX | 0.XX |
| ... | ... | ... | ... | ... |

## Propagation Test Results

### Test 1: Translation → Memorization

**Setup:**
- Initial memorization energy: 0.0
- Review translation node with rating: Good

**Results:**
- Final memorization energy: X.XX
- Energy gain: X.XX
- Propagation time: X ms

**Verdict:** ✅ PASS / ❌ FAIL

### Test 2: Tafsir → Translation

[Similar format]

### Test 3: Multiple Axes Accumulation

[Results]

## Synergy Effects

### Scenario Analysis

**Scenario 1: Direct Memorization**
- Review 1:10:memorization → Next verse energy: X.XX

**Scenario 2: Translation First**
- Review 1:11:translation → memorization energy: X.XX
- Then review 1:11:memorization → Next verse energy: X.XX + Y.YY

**Conclusion:** Cross-axis learning provides [X]% energy boost.

## Issues Found

[List any issues discovered during testing]

## Recommendations

[Any suggestions for improvements]
```

## Verification Plan

### Database Verification

```bash
cd rust

# Initialize database
cargo run --bin iqrah-cli -- init

# Run analysis script
./scripts/analyze_cross_axis_graph.sh
```

- [ ] Cross-axis edges exist (count > 0)
- [ ] Multiple axis pairs connected
- [ ] Edge weights reasonable (0.1 - 0.8)

### Integration Tests

```bash
cargo test cross_axis_propagation --nocapture
```

- [ ] `test_translation_helps_memorization` passes
- [ ] `test_tafsir_helps_translation` passes
- [ ] `test_propagation_event_recorded` passes
- [ ] `test_multiple_axes_accumulate_energy` passes

### Synergy Measurement

```bash
./scripts/measure_cross_axis_synergy.sh
```

- [ ] Script runs without errors
- [ ] Energy values show cross-axis effects
- [ ] Synergy is measurable (> 5% energy gain)

### Documentation

- [ ] Analysis document created
- [ ] Graph structure documented
- [ ] Test results recorded
- [ ] Issues (if any) documented

## Scope Limits & Safeguards

### ✅ MUST DO

- Verify cross-axis edges exist in database
- Test energy propagation across all major axis pairs
- Measure synergy effects quantitatively
- Document graph structure and findings
- Create comprehensive test suite

### ❌ DO NOT

- Modify graph generation (that's Task 2.1)
- Implement new propagation logic (already exists)
- Change edge weights (document what exists)
- Add new features (validation only)

### ⚠️ If Uncertain

- If no cross-axis edges found → Check Task 2.1 completed correctly
- If propagation doesn't work → Check LearningService implementation
- If energy values seem wrong → Document and report to user
- If tests fail → Document failure conditions clearly

### If Issues Found

If cross-axis edges are missing or broken:
1. Document the issue clearly
2. Report to user (don't try to fix Task 2.1)
3. Continue testing other aspects
4. Mark task as "blocked by Task 2.1"

## Success Criteria

- [ ] Cross-axis edges verified in database (SQL query results)
- [ ] Integration tests created (4+ test cases)
- [ ] All tests pass
- [ ] Synergy measurement script created and run
- [ ] Analysis document created with findings
- [ ] Graph structure documented
- [ ] Edge weights documented
- [ ] Propagation behavior validated
- [ ] No regressions (existing tests pass)

## Related Files

**Create These Files:**
- `/rust/tests/cross_axis_propagation_test.rs` - Integration tests
- `/rust/scripts/analyze_cross_axis_graph.sh` - Graph analysis script
- `/rust/scripts/measure_cross_axis_synergy.sh` - Synergy measurement
- `/docs/testing/cross-axis-propagation-analysis.md` - Findings documentation

**Verify These Files (No Changes):**
- `/rust/crates/iqrah-core/src/services/learning_service.rs` - Propagation logic
- `/rust/crates/iqrah-storage/migrations_content/20241124000002_knowledge_graph_full_axis.sql` - Cross-axis edges

**Dependencies:**
- Task 2.1 (Knowledge graph with cross-axis edges)

## Notes

### Expected Cross-Axis Synergies

Based on educational theory:

**Strong Synergies (weight 0.3-0.5):**
- Translation → Memorization (understanding helps recall)
- Contextual Memorization → Memorization (word-level helps verse-level)

**Medium Synergies (weight 0.2-0.3):**
- Tafsir → Translation (context helps understanding)
- Memorization → Translation (familiarity helps meaning)

**Weak Synergies (weight 0.1-0.2):**
- Tajweed → Memorization (pronunciation practice helps recall)

### Measurement Precision

Energy values are probabilistic (sampled from distributions), so:
- Run multiple trials for accuracy
- Accept variance of ±10%
- Focus on trends, not exact values

### Production Implications

If cross-axis propagation works:
- Users benefit from multi-modal learning
- Translation practice accelerates memorization
- Tafsir study deepens understanding
- System encourages holistic Quran learning

This validates the sophisticated knowledge graph design.
