# Handover: Task 1.4 - Integer ID Refactoring

**Prepared by:** Jules
**Date:** 2025-11-26

## 1. Objective

The primary goal is to complete **Task 1.4: Refactor SqliteContentRepository to use integer-based (`i64`) IDs** instead of `String` ukeys for all internal database operations and service logic. This aligns with the "Internal Ints, External Strings" architectural principle.

This task is a continuation of the work on branch `claude/revert-scheduler-candidates-011b51MVzfCZ3M6rGkZdK8yt`.

## 2. Summary of Work and Current State

The initial phase of the refactoring is complete, but it has resulted in widespread, cascading compilation errors across the `iqrah-core` crate.

### Actions Taken:

1.  **Core Data Model Refactoring:** The fundamental domain models in `rust/crates/iqrah-core/src/domain/models.rs` were updated. Structs like `Node`, `Edge`, and `MemoryState` now use `i64` for their ID fields (`id`, `node_id`, `source_id`, `target_id`).
2.  **Repository Trait Refactoring:** The core traits (`UserRepository` and `ContentRepository`) in `rust/crates/iqrah-core/src/ports/` were updated. Method signatures were changed to accept and return `i64` IDs where appropriate.
3.  **Service Layer Refactoring:** The business logic within services (`LearningService`, `SessionService`) and exercise generators (`exercises/`) were updated to use the new `i64`-based function signatures.
4.  **Mock Repository Refactoring:** An extensive effort was made to update the mock implementations of `ContentRepository` and `UserRepository` found throughout the various `_tests.rs` files to align with the updated traits.

### Current Status: **Blocked by Compilation Errors**

Despite these efforts, the workspace is in a non-compilable state. Running `cd rust && cargo test --no-run` reveals **over 200 compilation errors**, all stemming from type mismatches.

The core of the problem is a persistent and deep-rooted conflict between functions that now expect `i64` and the test code (and potentially other modules) that are still trying to pass `String` or `&str`.

## 3. Key Blocker

The fundamental blocker is the sheer volume and interconnectedness of the type mismatch errors. The refactoring has been attempted in a piecemeal fashion (fixing mocks, then services, then traits), which has led to a cyclical pattern of fixing one area and breaking another.

**Primary Error Type:** `mismatched types: expected i64, found &str` (or `String`).

This occurs in:
*   Function calls within tests.
*   Struct instantiations in test data setup.
*   Trait implementations in mock repositories.
*   Assertions (`assert_eq!`) comparing `i64` IDs with string literals.

## 4. Recommended Next Steps for the Next Agent

A systematic, bottom-up approach is required to resolve this. Do not attempt to fix test files in isolation. Let the compiler be your guide.

1.  **Verify Current State:** Start by running `cd rust && cargo test --no-run` from the project root to see the full list of current errors.

2.  **Focus on `iqrah-core`:** This crate is the epicenter of the errors. Resolve all issues here before moving to other crates.

3.  **Correct Function Signatures First (Top-Down within the Crate):**
    *   Go through the primary services and exercise generators (`LearningService`, `SessionService`, `exercises/*.rs`).
    *   Ensure all public `new` and other methods that previously took a `node_id: &str` or `String` are correctly refactored. **Critically, they must now accept both the `i64` ID and its corresponding string `ukey` if the ukey is needed for internal logic.** The previous agent may have incorrectly removed the `ukey` parameter entirely.
    *   Example: `pub async fn new(node_id: String, ...)` should become `pub async fn new(node_id: i64, ukey: &str, ...)`.

4.  **Fix Test Code (Bottom-Up Errors):**
    *   After correcting the function signatures, the compiler will now point to all the incorrect function *calls* within the `_tests.rs` files.
    *   Go to each test file indicated by the compiler (e.g., `exercises/translation_tests.rs`).
    *   Update the test data and `::new()` calls to pass the correct arguments (e.g., `Exercise::new(111, "WORD_INSTANCE:1:1:1", &repo)` instead of just `Exercise::new("WORD_INSTANCE:1:1:1", &repo)`).
    *   Update all `assert_eq!` macros to compare `i64` values, not strings.

5.  **Iterate and Re-compile:** After fixing one file, run `cargo test --no-run` again. The number of errors should decrease significantly with each file fixed. Continue this process until `iqrah-core` compiles successfully.

6.  **Address Downstream Crates:** Once `iqrah-core` is clean, move to `iqrah-storage` and `iqrah-api` to fix any remaining compilation errors that result from the updated trait definitions.

The final goal is a fully compilable workspace where `cd rust && cargo test` runs and all tests pass. Good luck.